<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>tracking.js - face with camera</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
  <link rel="stylesheet" href="style.css">

  <script src="https://code.jquery.com/jquery-3.3.1.min.js" crossorigin="anonymous"></script>


  <script src="tracking/build/tracking-min.js"></script>
  <script src="tracking/build/data/face-min.js"></script>


  <style>
  video, canvas {
    margin-left: 230px;
    margin-top: 120px;
    position: absolute;
  }
  </style>
</head>
<body>

<div class="container">
  <div id="page-head">

  </div>
  <div class="interactive-content">

    <div id="page-home" class="page">
       <div class="text-big">Welcome to the canteen.</div>
       <button type="button" class="col-8" class="button" id="home-faceid">FaceID</button>
       <button type="button" class="col-8" class="button" id="home-initials">Use initials</button>
    </div>

    <div id="page-idcamera" class="page">
      <div id="cameraframe">
        <video id="video" width="320" height="240" preload autoplay loop muted></video>
        <canvas id="canvas" width="320" height="240"></canvas>
      </div>
      
        <button type="button" class="button" class="col-8" id="cameraframe-cancel">Cancel</button>
      
    </div>

    <div id="page-cameraone" class="page">
       <span class="text-big" class="col-10">Please confirm you are <b id="found-name"></b>.</span>
       <button type="button" class="col-8" class="button" class="good" id="cameraone-confirm">That's me!</button>
       <button type="button" class="col-8" class="button" class="bad" id="cameraone-deny">Nope.</button>
    </div>

    <div id="page-cameramany" class="page">
       <div class="text-big">Who are you?<b id="found-name"></b>.</span>
       Need to generate these-----><div class="row"><button type="button" class="col-3" class="button">Use initials</button>
       <button type="button" class="col-8" class="button">None of these :(</button>
    </div>    

    <div id="page-camerafail" class="page">
       <div class="text-big">FaceID failed.</span>
       <button type="button" class="col-8" class="button" id="camerafail-retry">Retry</button>
       <button type="button" class="col-8" class="button" id="camerafail-initials">Use initials</button>
    </div>

    <div id="page-initials" class="page">
      <div class="text-small">Please enter your initials.</span>
      <input type="text" id="initials-text">
      <button type="button" class="col-8" class="button" id="camerafail-initials">Go</button>
    </div>

    <div id="page-initialsfail" class="page">
      <div class="text-small">Initials not recognised.</span>
      <button type="button" class="col-8" class="button" id="initialsfail-retry">Retry</button>
      <button type="button" class="col-8" class="button" id="initialsfail-cancel">Cancel</button>

    </div>


  </div>
  
  
  <div id="output">
  </div>

  </div>

  <script>
    $(function() {
      //Page setup


      //Var setup
      var scale = 0.25;
      var photoSent = false;

      var goHome = function() {
        $(".page").hide();
        $("#page-home").show();
        $("#home-faceid").click(function(){
          goFaceid();
        });
        $("#home-initials").click(function(){
          goInitials();
        });
      }

      var goFaceid = function() {
        $(".page").hide();
        $("#page-idcamera").show();

        photoSent = false;


        var video = document.getElementById('video');
        var canvas = document.getElementById('canvas');
        var context = canvas.getContext('2d');
      
        
      
        var tracker = new tracking.ObjectTracker('face');
        tracker.setInitialScale(4);
        tracker.setStepSize(2);
        tracker.setEdgesDensity(0.1);
       
        tracker.on('track', function(event) {
          context.clearRect(0, 0, canvas.width , canvas.height);

          event.data.forEach(function(rect) {

            if (photoSent){
              ignoreThisRun = true;
            }
            else{
              ignoreThisRun = false;
            }
            photoSent = true;

            if (!ignoreThisRun){
              var canvasCapture = document.createElement("canvas");
              canvasCapture.width = video.videoWidth * scale;
              canvasCapture.height = video.videoHeight * scale;
              canvasCapture.getContext('2d')
                    .drawImage(video, 0, 0, canvas.width, canvas.height);
       
              var img = document.createElement("img");
              dataURL = canvas.toDataURL();
          
              setTimeout(function () { trackerTask.stop(); video.pause(); video.srcObject.getVideoTracks()[0].stop(); }, 1);

              img.src = dataURL;
              document.getElementById("output").prepend(img);
              
              $(".demo-container").remove();

              $.ajax({
                type: "POST",
                url: "photoid.txt",
                data: {
                  imgBase64: dataURL
                }
              }).done(function(msg) {
                console.log(msg); 
              });            
            }
              //trackerTask.stop();
              
          });
        });

        trackerTask = tracking.track('#video', tracker, { camera: true });
      };


      goHome();


      
	  
	 
   
		
    //JS END -required })
    })
      //var trackerClearer = setInterval(function(){if (snapshotTaken = true){tracker.stop()}},1000);

  </script>

</body>
</html>
